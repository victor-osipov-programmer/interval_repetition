const cards = require("./db/cards.json");
const { save, randomInteger } = require("./utils");
const TelegramBot = require("node-telegram-bot-api");

const token = "6707557913:AAHEBUvkfZoVOK4MIBzYfZj4l_pXKXX5Lmw";
const bot = new TelegramBot(token, { polling: true });
const queue_add_cards = [];
const editable_cards = [];
const deleted_cards = [];

const second = 1000;
const minute = second * 60;
const hour = minute * 60;
const day = hour * 24;
const intervals = [
    {
        ms: 0,
    },
    {
        ms: minute,
    },
    {
        ms: 20 * minute,
    },
    {
        ms: hour,
    },
    {
        ms: 9 * hour,
    },
    {
        ms: 2 * day,
    },
    {
        ms: 6 * day,
    },
    {
        ms: 14 * day,
    },
    {
        ms: 30 * day,
    },
    {
        ms: 60 * day,
    },
    {
        ms: 180 * day,
    },
];

let cards_on_repeat = [];
let repetition_card = null;

function updateCardsOnRepeat() {
    cards_on_repeat = [];
    cards.forEach((card, index) => {
        if (card.repeat_date <= Date.now()) {
            cards_on_repeat.push({
                ...card,
                index,
            });
        }
    });
}

function setData(msg) {
    msg.answered = true;
    // repetition_card = null;
    removeFromQueues(msg);
}
function removeFromQueues(msg) {
    let index = queue_add_cards.findIndex(
        (user) => user.chat_id == msg.chat.id
    );
    if (index !== -1) queue_add_cards.splice(index, 1);

    index = editable_cards.findIndex((user) => user.chat_id == msg.chat.id);
    if (index !== -1) editable_cards.splice(index, 1);

    index = deleted_cards.findIndex((user) => user.chat_id == msg.chat.id);
    if (index !== -1) deleted_cards.splice(index, 1);
}

bot.onText(/\/start|üñ•?–ú–µ–Ω—é/iu, (msg) => {
    setData(msg);
    bot.sendMessage(
        msg.chat.id,
        "üéì–£–¥–æ–±–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —Ç–µ–º —Å –ø–æ–º–æ—â—å—é –∫–∞—Ä—Ç–æ—á–µ–∫ –≤–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏!",
        {
            reply_markup: {
                keyboard: [["üìã–ö–∞—Ä—Ç–æ—á–∫–∏", "‚è≥–û–±—É—á–µ–Ω–∏–µ"]],
                resize_keyboard: true,
            },
        }
    );
});

bot.onText(/üìã?–ö–∞—Ä—Ç–æ—á–∫–∏/iu, (msg) => {
    setData(msg);
    let cards_str = "";

    cards.forEach((card, index) => {
        cards_str += `${index + 1}‚ùì${card.question} ‚û°Ô∏è ${card.answer}\n`;
    });

    bot.sendMessage(msg.chat.id, "‚úçÔ∏è–ö–∞—Ä—Ç–æ—á–∫–∏:\n\n" + cards_str, {
        reply_markup: {
            keyboard: [
                ["‚úçÔ∏è–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É", "‚úèÔ∏è–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É"],
                ["üóë–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É"],
                ["üñ•–ú–µ–Ω—é"],
            ],
            resize_keyboard: true,
        },
    });
});

bot.onText(/(‚úçÔ∏è)?–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É/iu, async (msg) => {
    setData(msg);
    const index = queue_add_cards.findIndex(
        (user) => user.chat_id == msg.chat.id
    );
    const user = { chat_id: msg.chat.id };

    if (index !== -1) {
        queue_add_cards[index] = user;
    } else {
        queue_add_cards.push(user);
    }

    bot.sendMessage(msg.chat.id, "–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å", {
        reply_markup: {
            keyboard: [["üìã–ö–∞—Ä—Ç–æ—á–∫–∏"], ["üñ•–ú–µ–Ω—é"]],
            resize_keyboard: true,
        },
    });
});

bot.onText(/‚úèÔ∏è?–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É/iu, async (msg) => {
    setData(msg);
    const index = editable_cards.findIndex(
        (user) => user.chat_id == msg.chat.id
    );
    const user = { chat_id: msg.chat.id };

    if (index !== -1) {
        editable_cards[index] = user;
    } else {
        editable_cards.push(user);
    }

    bot.sendMessage(msg.chat.id, "‚å®Ô∏è–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏", {
        reply_markup: {
            keyboard: [["üìã–ö–∞—Ä—Ç–æ—á–∫–∏"], ["üñ•–ú–µ–Ω—é"]],
            resize_keyboard: true,
        },
    });
});

bot.onText(/üóë?–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É/iu, async (msg) => {
    setData(msg);
    const index = deleted_cards.findIndex(
        (user) => user.chat_id == msg.chat.id
    );
    const user = { chat_id: msg.chat.id };

    if (index !== -1) {
        deleted_cards[index] = user;
    } else {
        deleted_cards.push(user);
    }

    bot.sendMessage(msg.chat.id, "‚å®Ô∏è–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É–¥–∞–ª—è–µ–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏", {
        reply_markup: {
            keyboard: [["üìã–ö–∞—Ä—Ç–æ—á–∫–∏"], ["üñ•–ú–µ–Ω—é"]],
            resize_keyboard: true,
        },
    });
});

bot.onText(/‚è≥?–û–±—É—á–µ–Ω–∏–µ|üîÅ?–û–±–Ω–æ–≤–∏—Ç—å/iu, trainingCallback);

function trainingCallback(msg) {
    setData(msg);
    updateCardsOnRepeat();

    if (cards_on_repeat.length !== 0) {
        bot.sendMessage(
            msg.chat.id,
            `üéì–û—Å—Ç–∞–ª–æ—Å—å –∫–∞—Ä—Ç–æ—á–µ–∫: ${cards_on_repeat.length}`,
            {
                reply_markup: {
                    keyboard: [
                        ["–ó–Ω–∞—é", "–ù–µ –∑–Ω–∞—é"],
                        ["üëÄ–ü–æ–¥—Å–º–æ—Ç—Ä–µ—Ç—å"],
                        ["üîÅ–û–±–Ω–æ–≤–∏—Ç—å"],
                        ["üñ•–ú–µ–Ω—é"],
                    ],
                    resize_keyboard: true,
                },
            }
        );

        repetition_card =
            cards_on_repeat[randomInteger(0, cards_on_repeat.length - 1)];

        bot.sendMessage(msg.chat.id, `‚ùì–í–æ–ø—Ä–æ—Å: ${repetition_card.question}`);
    } else {
        const min_date = Math.min(...cards.map((card) => card.repeat_date));

        if (cards.length !== 0) {
            bot.sendMessage(
                msg.chat.id,
                `üëç–í—ã –ø–æ–≤—Ç–æ—Ä–∏–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏! –°–ª–µ–¥—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—è–≤—è—Ç—Å—è ${new Date(
                    min_date
                )}`,
                {
                    reply_markup: {
                        keyboard: [["üîÅ–û–±–Ω–æ–≤–∏—Ç—å"], ["üñ•–ú–µ–Ω—é"]],
                        resize_keyboard: true,
                    },
                }
            );
        } else {
            bot.sendMessage(msg.chat.id, `–ö–∞–∂–µ—Ç—Å—è –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–µ—Ç`, {
                reply_markup: {
                    keyboard: [
                        ["üîÅ–û–±–Ω–æ–≤–∏—Ç—å", "‚úçÔ∏è–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É"],
                        ["üñ•–ú–µ–Ω—é"],
                    ],
                    resize_keyboard: true,
                },
            });
        }
    }
}

bot.onText(/^–ó–Ω–∞—é$/i, async (msg) => {
    setData(msg);

    if (repetition_card) {
        const card = cards[repetition_card.index];

        card.interval += 1;
        card.repeat_date = Date.now() + intervals[card.interval].ms;

        save("./db/cards.json", cards);

        // updateCardsOnRepeat();

        trainingCallback(msg);
    }
});

bot.onText(/–ù–µ –∑–Ω–∞—é/i, async (msg) => {
    setData(msg);

    if (repetition_card) {
        const card = cards[repetition_card.index];

        card.interval = 0;
        card.repeat_date = Date.now() + intervals[card.interval].ms;

        save("./db/cards.json", cards);

        await bot.sendMessage(
            msg.chat.id,
            `–ù–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ, —Ç–µ–ø–µ—Ä—å —ç—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –±—É–¥–µ—Ç –ø–æ–ø–∞–¥–∞—Ç—å—Å—è —á–∞—â–µ`
        );
        trainingCallback(msg);
    }
});

bot.onText(/üëÄ?–ü–æ–¥—Å–º–æ—Ç—Ä–µ—Ç—å/iu, async (msg) => {
    setData(msg);

    if (repetition_card) {
        const card = cards[repetition_card.index];

        await bot.sendMessage(
            msg.chat.id,
            `–û—Ç–≤–µ—Ç: ${card.answer}`,
        );
        bot.sendMessage(
            msg.chat.id,
            `–¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—Ç—å, –∑–Ω–∞–ª(a) –ª–∏?`,
        );
    }
});

bot.onText(/.*/s, (msg) => {
    if (msg.answered) return;

    const user_add_card = queue_add_cards.find(
        (user) => user.chat_id == msg.chat.id
    );
    if (user_add_card) {
        if (!user_add_card.question) {
            user_add_card.question = msg.text;

            bot.sendMessage(msg.chat.id, "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç", {
                reply_markup: {
                    keyboard: [["üìã–ö–∞—Ä—Ç–æ—á–∫–∏"], ["üñ•–ú–µ–Ω—é"]],
                    resize_keyboard: true,
                },
            });
        } else if (!user_add_card.answer) {
            user_add_card.answer = msg.text;
            const interval = 0;

            cards.push({
                question: user_add_card.question,
                answer: user_add_card.answer,
                interval,
                repeat_date: Date.now() + intervals[interval].ms,
            });

            save("./db/cards.json", cards);

            bot.sendMessage(msg.chat.id, "–ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞", {
                reply_markup: {
                    keyboard: [
                        ["üìã–ö–∞—Ä—Ç–æ—á–∫–∏", "‚úçÔ∏è–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É"],
                        ["üñ•–ú–µ–Ω—é"],
                    ],
                    resize_keyboard: true,
                },
            });
        }

        return;
    }

    const user_editable_card = editable_cards.find(
        (user) => user.chat_id == msg.chat.id
    );
    if (user_editable_card) {
        if (!user_editable_card.card_number) {
            const card_number = parseInt(msg.text);
            user_editable_card.card_number = card_number;

            bot.sendMessage(msg.chat.id, "–ß—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å?", {
                reply_markup: {
                    keyboard: [["–í–æ–ø—Ä–æ—Å", "–û—Ç–≤–µ—Ç"], ["üìã–ö–∞—Ä—Ç–æ—á–∫–∏"], ["üñ•–ú–µ–Ω—é"]],
                    resize_keyboard: true,
                },
            });
        } else {
            if (/–í–æ–ø—Ä–æ—Å/i.test(msg.text)) {
                user_editable_card.is_question = true;
                bot.sendMessage(msg.chat.id, "–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å", {
                    reply_markup: {
                        keyboard: [["üìã–ö–∞—Ä—Ç–æ—á–∫–∏"], ["üñ•–ú–µ–Ω—é"]],
                        resize_keyboard: true,
                    },
                });
            } else if (/–û—Ç–≤–µ—Ç/i.test(msg.text)) {
                user_editable_card.is_answer = true;
                bot.sendMessage(msg.chat.id, "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç", {
                    reply_markup: {
                        keyboard: [["üìã–ö–∞—Ä—Ç–æ—á–∫–∏"], ["üñ•–ú–µ–Ω—é"]],
                        resize_keyboard: true,
                    },
                });
            } else {
                if (user_editable_card.is_question) {
                    user_editable_card.is_question = false;
                    cards[user_editable_card.card_number - 1].question =
                        msg.text;
                    save("./db/cards.json", cards);
                    bot.sendMessage(msg.chat.id, "–ö–∞—Ä—Ç–æ—á–∫–∞ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞", {
                        reply_markup: {
                            keyboard: [
                                ["üìã–ö–∞—Ä—Ç–æ—á–∫–∏", "‚úèÔ∏è–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É"],
                                ["üñ•–ú–µ–Ω—é"],
                            ],
                            resize_keyboard: true,
                        },
                    });
                } else if (user_editable_card.is_answer) {
                    user_editable_card.is_answer = false;
                    cards[user_editable_card.card_number - 1].answer = msg.text;
                    save("./db/cards.json", cards);
                    bot.sendMessage(msg.chat.id, "–ö–∞—Ä—Ç–æ—á–∫–∞ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞", {
                        reply_markup: {
                            keyboard: [
                                ["üìã–ö–∞—Ä—Ç–æ—á–∫–∏", "‚úèÔ∏è–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É"],
                                ["üñ•–ú–µ–Ω—é"],
                            ],
                            resize_keyboard: true,
                        },
                    });
                }
            }
        }

        return;
    }

    const user_deleted_card = deleted_cards.find(
        (user) => user.chat_id == msg.chat.id
    );
    if (user_deleted_card) {
        if (!user_deleted_card.card_number) {
            const card_number = parseInt(msg.text);
            user_deleted_card.card_number = card_number;

            cards.splice(user_deleted_card.card_number - 1, 1);
            save("./db/cards.json", cards);

            bot.sendMessage(msg.chat.id, "–ö–∞—Ä—Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞", {
                reply_markup: {
                    keyboard: [["üìã–ö–∞—Ä—Ç–æ—á–∫–∏", "üóë–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É"], ["üñ•–ú–µ–Ω—é"]],
                    resize_keyboard: true,
                },
            });
        }

        return;
    }

    bot.sendMessage(msg.chat.id, "üòî–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é —Ç–µ–±—è", {
        reply_markup: {
            keyboard: [["üñ•–ú–µ–Ω—é"]],
            resize_keyboard: true,
        },
    });
});
